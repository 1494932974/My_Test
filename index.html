<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿåˆ†æ•°ç³»ç»Ÿ - JSONBinä¿®å¤ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background-color: rgba(255, 255, 255, 0.95); border-radius: 10px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3); overflow: hidden; }
        .header { background: linear-gradient(to right, #2c3e50, #4a69bd); color: white; padding: 20px; text-align: center; }
        .class-selector { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .class-btn { padding: 8px 16px; background-color: rgba(255, 255, 255, 0.2); border: none; border-radius: 20px; color: white; cursor: pointer; transition: all 0.3s ease; }
        .class-btn:hover { background-color: rgba(255, 255, 255, 0.3); }
        .class-btn.active { background-color: white; color: #2c3e50; font-weight: bold; }
        .content { padding: 20px; }
        .student-list { background-color: #f8f9fa; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
        .student-table { width: 100%; border-collapse: collapse; }
        .student-table th, .student-table td { padding: 12px; text-align: center; border: 1px solid #ddd; }
        .student-table th { background-color: #4a69bd; color: white; }
        .student-table tr:nth-child(even) { background-color: #f2f2f2; }
        .student-table tr:hover { background-color: #e9ecef; }
        .rank-1 { background-color: gold !important; }
        .rank-2 { background-color: silver !important; }
        .rank-3 { background-color: #cd7f32 !important; }
        .score-controls { display: flex; justify-content: center; gap: 5px; }
        .score-btn { padding: 6px 12px; background-color: #4a69bd; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .score-btn.add { background-color: #28a745; }
        .score-btn.subtract { background-color: #dc3545; }
        .actions { padding: 15px; text-align: center; border-top: 1px solid #ddd; background-color: #f8f9fa; }
        .action-btn { padding: 10px 20px; margin: 0 10px; background-color: #4a69bd; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .cloud-btn { background-color: #17a2b8 !important; }
        .cloud-status { margin: 10px 0; padding: 8px; border-radius: 4px; font-size: 14px; }
        .status-online { background-color: #d4edda; color: #155724; }
        .status-offline { background-color: #f8d7da; color: #721c24; }
        .status-loading { background-color: #d1ecf1; color: #0c5460; }
        .save-notification { position: fixed; top: 20px; right: 20px; background-color: #28a745; color: white; padding: 10px 15px; border-radius: 5px; display: none; z-index: 1000; }
        
        .api-key-setup {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .api-key-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å­¦ç”Ÿåˆ†æ•°ç³»ç»Ÿ - JSONBinäº‘ç«¯ç‰ˆ</h1>
            <p>æ•°æ®å®æ—¶åŒæ­¥ï¼Œå¤šäººå¯åŒæ—¶è®¿é—®</p>
            <div class="class-selector" id="classSelector"></div>
        </div>
        
        <div class="content">
            <!-- APIå¯†é’¥è®¾ç½® -->
            <div class="api-key-setup" id="apiKeySetup">
                <h3>ğŸ”‘ ç¬¬ä¸€æ­¥ï¼šè®¾ç½® JSONBin API å¯†é’¥</h3>
                <p>è¯·è®¿é—® <a href="https://jsonbin.io/" target="_blank">jsonbin.io</a> æ³¨å†Œå¹¶è·å–å…è´¹APIå¯†é’¥</p>
                <input type="text" class="api-key-input" id="apiKeyInput" placeholder="åœ¨æ­¤ç²˜è´´ä½ çš„ $2a$10$... æ ¼å¼çš„APIå¯†é’¥">
                <button class="action-btn" onclick="saveAPIKey()">ä¿å­˜APIå¯†é’¥</button>
            </div>
            
            <div class="cloud-status" id="cloudStatus">ç­‰å¾…è®¾ç½®APIå¯†é’¥...</div>
            
            <div class="student-list">
                <h2 id="classTitle">å­¦ç”Ÿåˆ†æ•°æ’å</h2>
                <table class="student-table">
                    <thead>
                        <tr><th>æ’å</th><th>å§“å</th><th>åˆ†æ•°</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody id="studentTableBody"></tbody>
                </table>
            </div>
            
            <div class="actions">
                <button class="action-btn" id="resetScores">é‡ç½®åˆ†æ•°</button>
                <button class="action-btn cloud-btn" id="saveToCloud">ä¿å­˜åˆ°äº‘ç«¯</button>
                <button class="action-btn cloud-btn" id="loadFromCloud">ä»äº‘ç«¯åŠ è½½</button>
                <button class="action-btn" onclick="clearAPIKey()">é‡ç½®APIå¯†é’¥</button>
            </div>
        </div>
    </div>
    
    <div class="save-notification" id="saveNotification"></div>

    <script>
        // JSONBin.io é…ç½®
        let JSONBIN_API_KEY = '';
        let JSONBIN_BIN_ID = '';
        const JSONBIN_API_URL = 'https://api.jsonbin.io/v3/b';
        
        // ç¤ºä¾‹ç­çº§æ•°æ®
        const classes = {
            "2501ç­": ["ç™½ç’Ÿæ™Ÿ", "ç™½èŒ—å®‡", "é™ˆå­é’¦", "æ¨Šæ¾å˜‰", "å†¯å¥‡å¥‡"],
            "2502ç­": ["å®‰å²›æ¯…", "ç™½åŸ¹ä½‘", "ç¨‹é‘«æ´‹", "ç¨‹å®‡é‘«", "è‘£æ´ªåš"]
        };

        let classData = {};
        let currentClass = null;

        // åˆå§‹åŒ–ç³»ç»Ÿ
        function initSystem() {
            // åŠ è½½APIå¯†é’¥
            loadAPIKey();
            
            initDefaultData();
            initClassSelector();
            if (Object.keys(classes).length > 0) {
                selectClass(Object.keys(classes)[0]);
            }
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('resetScores').addEventListener('click', resetAllScores);
            document.getElementById('saveToCloud').addEventListener('click', saveToCloud);
            document.getElementById('loadFromCloud').addEventListener('click', loadFromCloud);
            
            updateUI();
        }

        // åŠ è½½APIå¯†é’¥
        function loadAPIKey() {
            const savedKey = localStorage.getItem('jsonbinApiKey');
            const savedBinId = localStorage.getItem('jsonbinBinId');
            
            if (savedKey) {
                JSONBIN_API_KEY = savedKey;
                JSONBIN_BIN_ID = savedBinId || '';
                document.getElementById('apiKeySetup').style.display = 'none';
                
                if (JSONBIN_BIN_ID) {
                    updateCloudStatus('å·²è¿æ¥åˆ°äº‘ç«¯ï¼Œç‚¹å‡»"ä»äº‘ç«¯åŠ è½½"è·å–æ•°æ®', 'online');
                } else {
                    updateCloudStatus('APIå¯†é’¥å·²è®¾ç½®ï¼Œç‚¹å‡»"ä¿å­˜åˆ°äº‘ç«¯"åˆ›å»ºæ•°æ®å­˜å‚¨', 'online');
                }
            } else {
                updateCloudStatus('è¯·å…ˆè®¾ç½®APIå¯†é’¥', 'offline');
            }
        }

        // ä¿å­˜APIå¯†é’¥
        function saveAPIKey() {
            const keyInput = document.getElementById('apiKeyInput');
            const apiKey = keyInput.value.trim();
            
            if (!apiKey) {
                alert('è¯·è¾“å…¥APIå¯†é’¥');
                return;
            }
            
            if (!apiKey.startsWith('$2a$10$')) {
                alert('APIå¯†é’¥æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”è¯¥ä»¥ $2a$10$ å¼€å¤´');
                return;
            }
            
            JSONBIN_API_KEY = apiKey;
            localStorage.setItem('jsonbinApiKey', apiKey);
            document.getElementById('apiKeySetup').style.display = 'none';
            updateCloudStatus('APIå¯†é’¥å·²ä¿å­˜ï¼ç‚¹å‡»"ä¿å­˜åˆ°äº‘ç«¯"å¼€å§‹ä½¿ç”¨', 'online');
        }

        // æ¸…é™¤APIå¯†é’¥
        function clearAPIKey() {
            localStorage.removeItem('jsonbinApiKey');
            localStorage.removeItem('jsonbinBinId');
            JSONBIN_API_KEY = '';
            JSONBIN_BIN_ID = '';
            document.getElementById('apiKeySetup').style.display = 'block';
            updateCloudStatus('APIå¯†é’¥å·²æ¸…é™¤', 'offline');
        }

        // ä¿å­˜åˆ°äº‘ç«¯
        async function saveToCloud() {
            if (!JSONBIN_API_KEY) {
                alert('è¯·å…ˆè®¾ç½®APIå¯†é’¥');
                return;
            }
            
            try {
                updateCloudStatus('æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...', 'loading');
                
                const dataToSave = {
                    classData: classData,
                    lastUpdated: new Date().toISOString(),
                    system: 'å­¦ç”Ÿåˆ†æ•°ç³»ç»Ÿ'
                };
                
                let url = JSONBIN_API_URL;
                let method = 'POST';
                
                if (JSONBIN_BIN_ID) {
                    url += '/' + JSONBIN_BIN_ID;
                    method = 'PUT';
                }
                
                // ä¿®å¤ï¼šä½¿ç”¨ç®€å•çš„headers
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(dataToSave)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.metadata && result.metadata.id) {
                    JSONBIN_BIN_ID = result.metadata.id;
                    localStorage.setItem('jsonbinBinId', JSONBIN_BIN_ID);
                }
                
                updateCloudStatus('æ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯ âœ“', 'online');
                showSaveNotification('æ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯ï¼');
                
                return result;
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                updateCloudStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'offline');
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // ä»äº‘ç«¯åŠ è½½
        async function loadFromCloud() {
            if (!JSONBIN_API_KEY) {
                alert('è¯·å…ˆè®¾ç½®APIå¯†é’¥');
                return;
            }
            
            if (!JSONBIN_BIN_ID) {
                alert('è¯·å…ˆä¿å­˜æ•°æ®åˆ°äº‘ç«¯');
                return;
            }
            
            try {
                updateCloudStatus('æ­£åœ¨ä»äº‘ç«¯åŠ è½½...', 'loading');
                
                const response = await fetch(JSONBIN_API_URL + '/' + JSONBIN_BIN_ID + '/latest', {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                
                const result = await response.json();
                const cloudData = result.record;
                
                if (cloudData && cloudData.classData) {
                    classData = cloudData.classData;
                    
                    // ç¡®ä¿æ•°æ®å®Œæ•´æ€§
                    for (let className in classes) {
                        if (!classData[className]) {
                            initializeClassData(className);
                        } else {
                            calculateRanking(className);
                        }
                    }
                    
                    updateUI();
                    updateCloudStatus('äº‘ç«¯æ•°æ®åŠ è½½æˆåŠŸ âœ“', 'online');
                    showSaveNotification('æ•°æ®åŠ è½½æˆåŠŸï¼');
                }
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                updateCloudStatus('åŠ è½½å¤±è´¥: ' + error.message, 'offline');
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°äº‘ç«¯çŠ¶æ€
        function updateCloudStatus(message, type) {
            const statusEl = document.getElementById('cloudStatus');
            statusEl.textContent = message;
            statusEl.className = 'cloud-status status-' + type;
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showSaveNotification(message) {
            const notification = document.getElementById('saveNotification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 2000);
        }

        // åˆå§‹åŒ–é»˜è®¤æ•°æ®
        function initDefaultData() {
            for (let className in classes) {
                initializeClassData(className);
            }
        }

        function initializeClassData(className) {
            classData[className] = classes[className].map(name => ({
                name: name,
                score: 100,
                rank: 1
            }));
            calculateRanking(className);
        }

        // åˆå§‹åŒ–ç­çº§é€‰æ‹©å™¨
        function initClassSelector() {
            const selector = document.getElementById('classSelector');
            for (let className in classes) {
                const btn = document.createElement('button');
                btn.className = 'class-btn';
                btn.textContent = className;
                btn.addEventListener('click', () => selectClass(className));
                selector.appendChild(btn);
            }
        }

        // é€‰æ‹©ç­çº§
        function selectClass(className) {
            currentClass = className;
            document.querySelectorAll('.class-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === className);
            });
            updateUI();
        }

        // æ›´æ–°UI
        function updateUI() {
            if (!currentClass) return;
            
            // æ›´æ–°æ ‡é¢˜
            const students = classData[currentClass];
            document.getElementById('classTitle').innerHTML = 
                `${currentClass} å­¦ç”Ÿåˆ†æ•°æ’å <span style="font-size:14px;color:#666;">(å…±${students.length}äºº)</span>`;
            
            // æ›´æ–°è¡¨æ ¼
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';
            
            students.forEach((student, index) => {
                const row = document.createElement('tr');
                if (student.rank === 1) row.className = 'rank-1';
                else if (student.rank === 2) row.className = 'rank-2';
                else if (student.rank === 3) row.className = 'rank-3';
                
                row.innerHTML = `
                    <td>${student.rank}</td>
                    <td>${student.name}</td>
                    <td>${student.score}</td>
                    <td class="score-controls">
                        <button class="score-btn add" data-index="${index}" data-change="5">+5</button>
                        <button class="score-btn add" data-index="${index}" data-change="10">+10</button>
                        <button class="score-btn subtract" data-index="${index}" data-change="-5">-5</button>
                        <button class="score-btn subtract" data-index="${index}" data-change="-10">-10</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            tbody.querySelectorAll('.score-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const index = parseInt(this.dataset.index);
                    const change = parseInt(this.dataset.change);
                    await updateStudentScore(index, change);
                });
            });
        }

        // æ›´æ–°å­¦ç”Ÿåˆ†æ•°
        async function updateStudentScore(index, change) {
            classData[currentClass][index].score += change;
            calculateRanking(currentClass);
            updateUI();
        }

        // è®¡ç®—æ’å
        function calculateRanking(className) {
            const students = classData[className];
            students.sort((a, b) => b.score - a.score);
            
            let rank = 1;
            students.forEach((student, index) => {
                if (index > 0 && student.score < students[index-1].score) {
                    rank = index + 1;
                }
                student.rank = rank;
            });
        }

        // é‡ç½®åˆ†æ•°
        async function resetAllScores() {
            if (confirm('ç¡®å®šé‡ç½®æ‰€æœ‰åˆ†æ•°ä¸º100å—ï¼Ÿ')) {
                initializeClassData(currentClass);
                updateUI();
            }
        }

        // å¯åŠ¨ç³»ç»Ÿ
        window.addEventListener('load', initSystem);
    </script>
</body>
</html>
